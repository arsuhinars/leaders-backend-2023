# Сервис автоматического распределения задач для выездных сотрудников банка

# Производственное решение

`production_solution.yaml`

Вертикально и горизонтально масштабируемый сервис. Сервис разделяется на frontend, распределитель нагрузки,
backend, db. Можно размножать количество backend серверов.

# База данных

`db_schema.drawio`

Сервис использует СУБД PostgreSQL.

База данных разделяется на несколько таблиц: 

account, employee, agent_point, task, task_status, task_manual

account. Таблица с данными об аккаунтах пользователей. Содержит логин, пароль, ФИО и роль. Пароль хранится в БД в виде хэша.
Методы сервиса не возвращают пароль-хеш.

employee. Таблица с данными о сотрудниках. Содержит грейд сотрудника и адрес начала работы.

agent_point. Таблица с агентскими точками. Содержит адрес точки, время подключения, доставлены ли материалы,
Кол-во дней после выдачи последней карты, Кол-во одобренных заявок, Кол-во выданных карт

task. Таблица с задачами. Содержит тип задачи, дату выполнения, начало времени выполнения, 
сколько часов занимает задача, дистанция до задачи от работника, номер в очереди по счету сегодняшних задач

task_status. Таблица со статусом задачи. Содержит выполнена ли задача, комментарий. 
Сотрудник может ставить статус задаче и оставлять комментарии по мере выполнения задачи.

task_manual. Таблица с типом задачи и условиями задачи. Содержит приоритет, время выполнения,
требуемый уровень сотрудника. В зависимости от типа задачи содержит разные условия. Хранятся условия в
виде json. Поле в базе данных представляет собой абстрактный класс BaseTaskManual, 
который могут унаследовать разные задачи. Условия в зависимости от сохраняемого класса (типа задачи):

Для задачи выезда на точку для стимулирования выдач: число в первом условии и число во втором условии.

Для задачи обучения агента: число, которое выражает процент; второе число.

Для задачи доставки карт и материалов: время подключения.

# API схема

Схема api доступна:

`api_schema.yaml`

В некоторых методах добавлена возможность пагинации.
Методы разделены правами доступа на Админа, менеджера и сотрудника.
Методы защищены http basic authentication.

Всего 5 заголовков, которые соответствуют названиям таблиц в БД:
Accounts, Agent points, Task manual, Employees, Tasks.

Accounts. В методах нельзя получить пароль.

Task manual. Методы для разных задач разделены разными url путями.

Можно динамически указывать порты, настройки БД, токен к graphhoper geocoding в файле:

`.env`

## Stack

Java 17, Spring, PostgreSQL, Docker, GraphHopper, Jenetics, traefik

## Особенности

api token graphhopper используется только для геокодинга. Построением маршрутов занимается подтянутый с
помощью pom.xml open source, установленный локально движок graphhopper.

## Запуск

1) Скачиваем файл `south-fed-district-latest.osm.pbf` с сайта https://download.geofabrik.de/russia/south-fed-district.html
   И кладем в папку по адресу "./graph_hopper/south-fed-district-latest.osm.pbf"

***Примечание: для работы приложения по всей России, нужно скачать карту всей России.***  
Можно также ограничиться нужным вам регионом.

2) docker compose up
